@page "/devices"
@using Microsoft.EntityFrameworkCore
@using HomeManagement.Components.Dialogs
@inject ISnackbar Snackbar
@inject IDbContextFactory<HomeManagementDbContext> DbContextFactory
@inject IDialogService DialogService
@using System.Net.NetworkInformation
@attribute [Authorize]

<PageTitle>Devices</PageTitle>

<MudTable @ref="table" ServerData="ServerReload" Dense="true" Hover="true">
	<ToolBarContent>
		<MudText Typo="Typo.h6">Devices</MudText>
		<MudSpacer />
		<MudButton Variant="Variant.Filled" Color="Color.Primary" Class="me-2 mb-1" OnClick="table.ReloadServerData">Refresh</MudButton>

		<MudButton Variant="Variant.Filled" Color="Color.Primary" Class="me-2 mb-1" OnClick="ScanNetworkDevices">Scan</MudButton>

		<MudButton Variant="Variant.Filled" Color="Color.Primary" Class="me-2 mb-1" OnClick="Add">Add</MudButton>
	</ToolBarContent>
	<HeaderContent>
		<MudTh><MudTableSortLabel T="Device">IP</MudTableSortLabel></MudTh>
		<MudTh><MudTableSortLabel T="Device">Name</MudTableSortLabel></MudTh>
		<MudTh>Status</MudTh>
		<MudTh>Uptime</MudTh>
		<MudTh><MudTableSortLabel T="Device">Actions</MudTableSortLabel></MudTh>
		<MudTh></MudTh>
	</HeaderContent>
	<RowTemplate>
		<MudTd DataLabel="IP">@context.Ip</MudTd>
		<MudTd DataLabel="Name">@context.Name</MudTd>
		<MudTd DataLabel="Status">
			@{
				var st = GetStatus(context.Name);
				if (st is null || st.Loading)
				{
					<MudProgressCircular Indeterminate="true" Size="Size.Small" />
				}
				else
				{
					<MudChip T="string" Color="@(st.Online? Color.Success: Color.Error)" Variant="Variant.Filled">@(st.Online ? "Online" : "Offline")</MudChip>
				}
			}
		</MudTd>
		<MudTd DataLabel="Uptime">
			@FormatDuration(GetStatus(context.Name)?.UptimeSeconds)
		</MudTd>
		<MudTd DataLabel="Actions">
			@foreach (var action in context.Actions)
			{
				var st = GetStatus(context.Name);
				var disabled = st is null || st.Loading || !st.Online || runningActions.Contains((context.Name, action));
				<MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary" Disabled="@disabled" OnClick="@(() => RunAction(context, action))" Class="me-2 mb-1">
					@if (runningActions.Contains((context.Name, action)))
					{
						<MudProgressCircular Indeterminate="true" Size="Size.Small" Class="me-1" />
					}
					@action.Action
				</MudButton>
			}
		</MudTd>
		<MudTd>
			<MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="() => Edit(context)" />
			<MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => Delete(context)" />
		</MudTd>
	</RowTemplate>
	<NoRecordsContent>
		<MudText>No devices found</MudText>
	</NoRecordsContent>
	<LoadingContent>
		<MudText>Loading...</MudText>
	</LoadingContent>
	<PagerContent>
		<MudTablePager />
	</PagerContent>
</MudTable>

@code {

	private MudTable<Device> table = null!;
	private readonly Dictionary<string, DeviceStatus> statuses = new();
	private readonly HashSet<(string DeviceName, DeviceAction Action)> runningActions = new();

	private async Task<TableData<Device>> ServerReload(TableState state, CancellationToken token)
	{
		await using var dbContext = await DbContextFactory.CreateDbContextAsync(token);
		var query = dbContext.Devices.Include(d => d.Actions).OrderBy(d => d.Name);

		var totalItems = await query.CountAsync(token);
		var devices = await query.Skip(state.Page * state.PageSize).Take(state.PageSize).ToListAsync(token);

		// Start/refresh status fetch for current page devices
		_ = UpdateStatusesAsync(devices, token);

		return new TableData<Device>() { TotalItems = totalItems, Items = devices };
	}

	private async Task UpdateStatusesAsync(IEnumerable<Device> devices, CancellationToken token)
	{
		var tasks = new List<Task>();
		foreach (var device in devices)
		{
			if (!statuses.TryGetValue(device.Name, out var st))
			{
				st = new DeviceStatus();
				statuses[device.Name] = st;
			}

			st.Loading = true;
			tasks.Add(UpdateDeviceStatusAsync(device, st, token));
		}

		StateHasChanged();
		await Task.WhenAll(tasks);
		StateHasChanged();
	}

	private async Task UpdateDeviceStatusAsync(Device device, DeviceStatus status, CancellationToken token)
	{
		try
		{
			var info = await NetworkManager.GetDeviceInfoAsync(device.Ip, token);
			if (info is not null)
			{
				status.Online = true;
				status.UptimeSeconds = info.UptimeSeconds;
			}
			else
			{
				using var ping = new Ping();
				var reply = await ping.SendPingAsync(device.Ip, 250);
				status.Online = reply.Status == IPStatus.Success;
				status.UptimeSeconds = null;
			}
		}
		catch
		{
			status.Online = false;
			status.UptimeSeconds = null;
		}
		finally
		{
			status.Loading = false;
		}
	}

	private DeviceStatus? GetStatus(string name) => statuses.TryGetValue(name, out var st) ? st : null;

	private async Task RunAction(Device device, DeviceAction action)
	{
		var key = (device.Name, action);
		if (!runningActions.Add(key))
		{
			return;
		}

		try
		{
			using var httpClient = new HttpClient();
			httpClient.BaseAddress = new Uri($"http://{device.Ip}");
			var result = action.CommandType switch
			{
				CommandType.Get => await httpClient.GetAsync($"{action.Command}?{action.CommandArgs}"),
				CommandType.Post => await httpClient.PostAsync(action.Command, string.IsNullOrWhiteSpace(action.CommandArgs) ? null : new StringContent(action.CommandArgs)),
				_ => throw new ArgumentOutOfRangeException()
			};

			Snackbar.Add(await result.Content.ReadAsStringAsync(), result.IsSuccessStatusCode ? Severity.Success : Severity.Error);
		}
		catch (Exception ex)
		{
			Snackbar.Add(ex.Message, Severity.Error);
		}
		finally
		{
			runningActions.Remove(key);
		}
	}

	public static string FormatDuration(int? seconds)
	{
		if (seconds is null)
		{
			return string.Empty;
		}

		var ts = TimeSpan.FromSeconds(seconds.Value);
		var parts = new List<string>();
		if (ts.Days > 0)
		{
			parts.Add($"{ts.Days}d");
		}

		if (ts.Hours > 0 || parts.Count > 0)
		{
			parts.Add($"{ts.Hours}h");
		}

		if (ts.Minutes > 0 || parts.Count > 0)
		{
			parts.Add($"{ts.Minutes}m");
		}

		parts.Add($"{ts.Seconds}s");
		return string.Join(" ", parts);
	}

	private async Task ScanNetworkDevices()
	{
		var dialog = await DialogService.ShowAsync<ScanDevicesDialog>("Scan Network");
		var result = await dialog.Result;
		if (result is null || result.Canceled)
		{
			return;
		}

		var devices = (List<NetworkDevice>)result.Data!;
		if (devices.Count == 0)
		{
			return;
		}

		try
		{
			await using var dbContext = await DbContextFactory.CreateDbContextAsync();
			foreach (var device in devices)
			{
				dbContext.Devices.Add(device);
			}

			await dbContext.SaveChangesAsync();
			Snackbar.Add($"Added {devices.Count} device(s).", Severity.Success);
			await table.ReloadServerData();
		}
		catch (Exception ex)
		{
			Snackbar.Add($"Failed to add scanned devices: {ex.InnerException?.Message ?? ex.Message}", Severity.Error);
		}
	}

	private async Task Add()
	{
		var dialog = await DialogService.ShowAsync<IpAddressDialog>("Enter Address");
		var result = await dialog.Result;
		if (result is null || result.Canceled)
		{
			return;
		}

		var device = (NetworkDevice)result.Data!;
		try
		{
			await using var dbContext = await DbContextFactory.CreateDbContextAsync();
			dbContext.Devices.Add(device);
			await dbContext.SaveChangesAsync();

			Snackbar.Add($"Device '{device.Name}' added.", Severity.Success);
			await table.ReloadServerData();
		}
		catch (Exception ex)
		{
			Snackbar.Add($"Failed to add device: {ex.Message}", Severity.Error);
		}
	}

	private async Task Edit(Device device)
	{
		var parameters = new DialogParameters
		{
			["Model"] = new DeviceEditModel
			{
				Name = device.Name,
				Ip = device.Ip,
				Actions = device.Actions.Select(a => new DeviceActionEditModel { Action = a.Action, Command = a.Command, CommandArgs = a.CommandArgs, CommandType = a.CommandType }).ToList()
			}
		};
		var dialog = await DialogService.ShowAsync<DeviceEditDialog>($"Edit {device.Name}", parameters);
		var result = await dialog.Result;
		if (result is null || result.Canceled)
		{
			return;
		}

		var model = (DeviceEditModel)result.Data!;
		try
		{
			await using var dbContext = await DbContextFactory.CreateDbContextAsync();
			var existing = await dbContext.Devices.FirstOrDefaultAsync(d => d.Name == device.Name);
			if (existing is null)
			{
				Snackbar.Add("Device not found.", Severity.Error);
				return;
			}
			dbContext.Devices.Remove(existing);
			var replacement = new Device()
			{
				Name = model.Name,
				Ip = model.Ip,
				Actions = model.Actions.Select(a => new DeviceAction(a.Action, a.CommandType, a.Command, a.CommandArgs)).ToList()
			};
			dbContext.Devices.Add(replacement);
			await dbContext.SaveChangesAsync();

			Snackbar.Add("Device updated.", Severity.Success);
			await table.ReloadServerData();
		}
		catch (Exception ex)
		{
			Snackbar.Add($"Failed to update device: {ex.Message}", Severity.Error);
		}
	}

	private async Task Delete(Device device)
	{
		try
		{
			await using var dbContext = await DbContextFactory.CreateDbContextAsync();
			var existing = await dbContext.Devices.FirstOrDefaultAsync(d => d.Name == device.Name);
			if (existing is null)
			{
				Snackbar.Add("Device not found in DB.", Severity.Warning);
				return;
			}

			dbContext.Devices.Remove(existing);
			await dbContext.SaveChangesAsync();
			Snackbar.Add($"Deleted {device.Name}.", Severity.Success);
			await table.ReloadServerData();
		}
		catch (Exception ex)
		{
			Snackbar.Add($"Failed to delete device: {ex.Message}", Severity.Error);
		}
	}

	private class DeviceStatus
	{
		public bool Online { get; set; }
		public int? UptimeSeconds { get; set; }
		public bool Loading { get; set; } = true;
	}
}