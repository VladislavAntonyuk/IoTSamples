@page "/devices"
@attribute [Authorize]

<PageTitle>Devices</PageTitle>

<MudTable @ref="_table" ServerData="ServerReload" Dense="true" Hover="true">
	<ToolBarContent>
		<MudText Typo="Typo.h6">Devices</MudText>
		<MudSpacer />
		<MudButton Variant="Variant.Filled" Color="Color.Primary" Class="me-2 mb-1" OnClick="_table.ReloadServerData">Refresh</MudButton>

		<MudButton Variant="Variant.Filled" Color="Color.Primary" Class="me-2 mb-1" OnClick="ScanNetworkDevices">Scan</MudButton>

		<MudButton Variant="Variant.Filled" Color="Color.Primary" Class="me-2 mb-1" OnClick="Add">Add</MudButton>
	</ToolBarContent>
	<HeaderContent>
		<MudTh><MudTableSortLabel T="Device">IP</MudTableSortLabel></MudTh>
		<MudTh><MudTableSortLabel T="Device">Name</MudTableSortLabel></MudTh>
		<MudTh>Status</MudTh>
		<MudTh>Uptime</MudTh>
		<MudTh><MudTableSortLabel T="Device">Actions</MudTableSortLabel></MudTh>
		<MudTh></MudTh>
	</HeaderContent>
	<RowTemplate>
		<MudTd DataLabel="IP">@context.Ip</MudTd>
		<MudTd DataLabel="Name">@context.Name</MudTd>
		<MudTd DataLabel="Status">
			@{
				var st = GetStatus(context.Name);
				if (st is null || st.Loading)
				{
					<MudProgressCircular Indeterminate="true" Size="Size.Small" />
				}
				else
				{
					<MudChip T="string" Color="@(st.Online? Color.Success: Color.Error)" Variant="Variant.Filled">@(st.Online ? "Online" : "Offline")</MudChip>
				}
			}
		</MudTd>
		<MudTd DataLabel="Uptime">
			@FormatDuration(GetStatus(context.Name)?.UptimeSeconds)
		</MudTd>
		<MudTd DataLabel="Actions">
			@foreach (var action in context.Actions)
			{
				var st = GetStatus(context.Name);
				var disabled = st is null || st.Loading || !st.Online || _runningActions.Contains((context.Name, action));
				<MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary" Disabled="@disabled" OnClick="@(() => RunAction(context, action))" Class="me-2 mb-1">
					@if (_runningActions.Contains((context.Name, action)))
					{
						<MudProgressCircular Indeterminate="true" Size="Size.Small" Class="me-1" />
					}
					@action.Action
				</MudButton>
			}
		</MudTd>
		<MudTd>
			<MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="() => Edit(context)" />
			<MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => Delete(context)" />
		</MudTd>
	</RowTemplate>
	<NoRecordsContent>
		<MudText>No devices found</MudText>
	</NoRecordsContent>
	<LoadingContent>
		<MudText>Loading...</MudText>
	</LoadingContent>
	<PagerContent>
		<MudTablePager />
	</PagerContent>
</MudTable>