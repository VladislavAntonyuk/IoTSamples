@namespace HomeManagement.Components.Dialogs
@using MudBlazor
@inherits ComponentBase

<MudPaper Class="pa-4" Elevation="1" Style="min-width:320px;">
	<MudStack Spacing="2">
		<MudText Typo="Typo.h6">Add Device</MudText>
		<MudTextField @bind-Value="Address" Label="Address" Required="true" Immediate="true" ErrorText="@_error" Error="@(!string.IsNullOrEmpty(_error))" />
		<MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
			<MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Cancel">Cancel</MudButton>
			<MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="string.IsNullOrWhiteSpace(Address) || _isBusy" OnClick="Save">
				@if (_isBusy)
				{
					<MudProgressCircular Indeterminate="true" Size="Size.Small" Class="me-1" />
				}

				Add
			</MudButton>
		</MudStack>
	</MudStack>
</MudPaper>

@code {
	[CascadingParameter] IMudDialogInstance DialogReference { get; set; } = default!;
	private string Address { get; set; } = string.Empty;
	private string? _error;
	bool _isBusy;

	private async Task Save()
	{
		if (string.IsNullOrWhiteSpace(Address))
		{
			return;
		}

		_isBusy = true;
		var address = Address.Trim();
		var networkDevice = await NetworkManager.GetDeviceInfoAsync(address, CancellationToken.None);
		_isBusy = false;
		if (networkDevice is null)
		{
			_error = "Could not reach device at this address.";
			return;
		}

		DialogReference.Close(DialogResult.Ok(networkDevice));
	}

	private void Cancel() => DialogReference.Close(DialogResult.Cancel());
}
