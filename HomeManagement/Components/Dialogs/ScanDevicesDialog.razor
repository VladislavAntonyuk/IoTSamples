@namespace HomeManagement.Components.Dialogs
@using MudBlazor
@inject ISnackbar Snackbar
@using HomeManagement.Components.Dialogs
@inherits ComponentBase

<MudPaper Class="pa-4" Elevation="1" Style="min-width:500px;max-width:800px;">
	<MudStack Spacing="2">
		<MudText Typo="Typo.h6">Discovered Devices</MudText>
		<MudTable T="SelectableDevice" Items="_devices" Dense="true" Hover="true" Bordered="true" Class="my-2">
			<HeaderContent>
				<MudTh></MudTh>
				<MudTh>IP</MudTh>
				<MudTh>Name</MudTh>
				<MudTh>Uptime</MudTh>
			</HeaderContent>
			<RowTemplate>
				<MudTd><MudCheckBox T="bool" @bind-Value="context.Selected" /></MudTd>
				<MudTd>@context.Device.Ip</MudTd>
				<MudTd>@context.Device.Name</MudTd>
				<MudTd>@FormatDuration(context.Device.UptimeSeconds)</MudTd>
			</RowTemplate>
			<NoRecordsContent>
				<MudText>No devices found</MudText>
			</NoRecordsContent>
		</MudTable>
		<MudProgressCircular Indeterminate="true" Style="@(_loading ? "" : "display:none;")" />
		<MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
			<MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Cancel">Cancel</MudButton>
			<MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!_devices.Any(d => d.Selected))" OnClick="Save">Add Selected</MudButton>
		</MudStack>
	</MudStack>
</MudPaper>

@code {
	[CascadingParameter] IMudDialogInstance DialogReference { get; set; } = default!;

	private List<SelectableDevice> _devices = new();
	private bool _loading = true;

	protected override async Task OnInitializedAsync()
	{
		try
		{
			var baseIp = NetworkManager.GetLocalSubnet();
			if (baseIp is null)
			{
				Snackbar.Add("No active IPv4 network interface found.", Severity.Error);
				return;
			}

			var networkDevices = await NetworkManager.ScanNetworkAsync(baseIp, 100, CancellationToken.None);

			_devices = networkDevices.Select(d => new SelectableDevice { Device = d }).ToList();
		}
		catch { }
		finally
		{
			_loading = false;
		}
	}

	private void Save()
	{
		var chosen = _devices.Where(d => d.Selected).Select(d => d.Device).ToList();
		DialogReference.Close(DialogResult.Ok(chosen));
	}

	private void Cancel() => DialogReference.Close(DialogResult.Cancel());

	public static string FormatDuration(long totalSeconds)
	{
		var ts = TimeSpan.FromSeconds(totalSeconds);

		var parts = new List<string>();

		if (ts.Days > 0)
		{
			parts.Add($"{ts.Days} day{(ts.Days > 1 ? "s" : "")}");
		}

		if (ts.Hours > 0 || parts.Count > 0)
		{
			parts.Add($"{ts.Hours} hour{(ts.Hours != 1 ? "s" : "")}");
		}

		if (ts.Minutes > 0 || parts.Count > 0)
		{
			parts.Add($"{ts.Minutes} minute{(ts.Minutes != 1 ? "s" : "")}");
		}

		parts.Add($"{ts.Seconds} second{(ts.Seconds != 1 ? "s" : "")}");

		return string.Join(", ", parts);
	}
}
